<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PBP Matchup Analysis â€” Georgia vs Arizona State</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: { extend: { fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] } } }
        }
    </script>
    <style>
        body { font-family: 'Inter', system-ui, sans-serif; background: #09090b; color: #fafafa; }
        .glass { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); }
        .stat-card { transition: all 0.2s ease; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 8px 24px -8px rgba(0,0,0,0.4); }
        .nav-pill { transition: all 0.15s ease; }
        .nav-pill:hover { background: rgba(255,255,255,0.08); }
        .nav-pill.active { background: rgba(239,68,68,0.15); color: #ef4444; border-color: rgba(239,68,68,0.3); }
        .filter-chip { transition: all 0.15s ease; cursor: pointer; }
        .filter-chip:hover { background: rgba(255,255,255,0.08); }
        .filter-chip.active { background: rgba(239,68,68,0.15); color: #ef4444; border-color: rgba(239,68,68,0.4); }
        .table-row:hover { background: rgba(255,255,255,0.03); }
        .team-a { color: #ef4444; }
        .team-b { color: #f97316; }
        .team-a-bg { background: rgba(239,68,68,0.1); border-color: rgba(239,68,68,0.2); }
        .team-b-bg { background: rgba(249,115,22,0.1); border-color: rgba(249,115,22,0.2); }
        .team-a-bar { background: #ef4444; }
        .team-b-bar { background: #f97316; }
        .section-enter { animation: sectionEnter 0.4s ease-out; }
        @keyframes sectionEnter { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
        .schedule-row:hover { background: rgba(255,255,255,0.04); }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
        .vs-badge { background: linear-gradient(135deg, #ef4444, #f97316); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .collapsible-body { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
        .collapsible-body.open { max-height: 320px; overflow-y: auto; }
        .chevron { transition: transform 0.3s ease; }
        .chevron.open { transform: rotate(180deg); }
        .vt-logo-icon { background: rgba(255,255,255,0.95); padding: 4px; border-radius: 8px; }
    </style>
</head>
<body class="min-h-screen">

<!-- Top Bar -->
<nav class="fixed top-0 w-full z-50 border-b border-white/5 bg-[#09090b]/80 backdrop-blur-xl">
    <div class="max-w-7xl mx-auto px-6 h-14 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <img src="assets/vt-logo-icon.png" alt="VT Sports Solutions" class="vt-logo-icon" style="height:32px">
            <span class="text-sm font-semibold text-zinc-200">Matchup Analysis</span>
            <span class="text-xs text-zinc-500 ml-1" id="buildVersion">2b43abe â€¢ 2026-02-12 05:18 PM MST</span>
        </div>
        <div class="flex items-center gap-2" id="filterBar">
            <span class="text-xs text-zinc-500 mr-1">Filter:</span>
        </div>
    </div>
</nav>

<!-- Team Header -->
<div class="pt-20 pb-4 max-w-7xl mx-auto px-6">
    <div class="flex items-center justify-center gap-6">
        <div class="text-right">
            <h1 class="text-3xl font-extrabold team-a" id="teamAName">Georgia</h1>
            <p class="text-sm text-zinc-400" id="teamARecord">12-1 Â· SEC</p>
        </div>
        <div class="text-4xl font-black vs-badge">VS</div>
        <div class="text-left">
            <h1 class="text-3xl font-extrabold team-b" id="teamBName">Arizona State</h1>
            <p class="text-sm text-zinc-400" id="teamBRecord">5-7 Â· Big 12</p>
        </div>
    </div>
</div>

<!-- Tab Navigation -->
<div class="sticky top-14 z-40 border-b border-white/5 bg-[#09090b]/90 backdrop-blur-xl">
    <div class="max-w-7xl mx-auto px-6 flex gap-1 overflow-x-auto py-2" id="tabNav"></div>
</div>

<!-- Main Content -->
<main class="max-w-7xl mx-auto px-6 py-6" id="mainContent"></main>

<script>
let DATA = null;
let currentTab = 'overview';
let currentFilter = 'all';
let allPlaysQuery = '';

const TABS = [
    { id: 'overview', label: 'Overview', icon: 'ðŸ“Š' },
    { id: 'middle8', label: 'Middle 8', icon: 'â±ï¸' },
    { id: 'explosives', label: 'Explosive Plays', icon: 'ðŸ’¥' },
    { id: 'redzone', label: 'Red Zone', icon: 'ðŸ”´' },
    { id: 'penalties', label: 'Penalties', icon: 'ðŸš©' },
    { id: '4thdown', label: '4th Down', icon: 'ðŸŽ¯' },
    { id: 'turnovers', label: 'Turnovers', icon: 'ðŸ”„' },
    { id: 'postturnovers', label: 'Post-Turnover', icon: 'ðŸ”„' },
    { id: 'specialteams', label: 'Special Teams', icon: 'ðŸˆ' },
    { id: 'allplays', label: 'All Plays', icon: 'ðŸ“‹' },
];

const FILTERS = [
    { id: 'all', label: 'All Games' },
    { id: 'conf', label: 'Conference' },
    { id: 'nonconf', label: 'Non-Conference' },
    { id: 'power4', label: 'Power 4' },
    { id: 'last3', label: 'Last 3' },
];

function filterGames(games) {
    switch(currentFilter) {
        case 'conf': return games.filter(g => g.conference);
        case 'nonconf': return games.filter(g => !g.conference);
        case 'power4': return games.filter(g => g.is_power4);
        case 'last3': return games.slice(-3);
        default: return games;
    }
}

function agg(games) {
    const n = games.length || 1;
    const pf = games.reduce((s,g) => s + g.points_for, 0);
    const pa = games.reduce((s,g) => s + g.points_against, 0);
    const wins = games.filter(g => g.points_for > g.points_against).length;
    const losses = n - wins;
    const expl = games.reduce((s,g) => s + g.explosives, 0);
    const pen = games.reduce((s,g) => s + g.penalties, 0);
    const tof = games.reduce((s,g) => s + g.turnovers_gained, 0);
    const tol = games.reduce((s,g) => s + g.turnovers_lost, 0);
    const rzt = games.reduce((s,g) => s + g.red_zone_trips, 0);
    const rztd = games.reduce((s,g) => s + g.red_zone_tds, 0);
    const rzfg = games.reduce((s,g) => s + g.red_zone_fgs, 0);
    
    // New zone stats
    const green_zone_trips = games.reduce((s,g) => s + (g.green_zone_trips || 0), 0);
    const green_zone_tds = games.reduce((s,g) => s + (g.green_zone_tds || 0), 0);
    const green_zone_fgs = games.reduce((s,g) => s + (g.green_zone_fgs || 0), 0);
    const green_zone_failed = games.reduce((s,g) => s + (g.green_zone_failed || 0), 0);
    
    const tight_red_zone_trips = games.reduce((s,g) => s + (g.tight_red_zone_trips || 0), 0);
    const tight_red_zone_tds = games.reduce((s,g) => s + (g.tight_red_zone_tds || 0), 0);
    const tight_red_zone_fgs = games.reduce((s,g) => s + (g.tight_red_zone_fgs || 0), 0);
    const tight_red_zone_failed = games.reduce((s,g) => s + (g.tight_red_zone_failed || 0), 0);
    
    return {
        games: n, wins, losses, record: `${wins}-${losses}`,
        pf, pa, ppg: (pf/n).toFixed(1), oppg: (pa/n).toFixed(1),
        expl, explpg: (expl/n).toFixed(1),
        pen, penpg: (pen/n).toFixed(1),
        tof, tol, tom: tof - tol,
        rzt, rztd, rzfg,
        rzpct: rzt ? ((rztd+rzfg)/rzt*100).toFixed(1) : '0',
        rztdpct: rzt ? (rztd/rzt*100).toFixed(1) : '0',
        green_zone_trips, green_zone_tds, green_zone_fgs, green_zone_failed,
        red_zone_trips: rzt, red_zone_tds: rztd, red_zone_fgs: rzfg,
        tight_red_zone_trips, tight_red_zone_tds, tight_red_zone_fgs, tight_red_zone_failed,
    };
}

function sumField(games, field) {
    return games.reduce((s,g) => s + (g[field] || 0), 0);
}

function sumSpecial(games, field) {
    return games.reduce((s,g) => s + ((g.special_teams && g.special_teams[field]) || 0), 0);
}

function maxSpecial(games, field) {
    return games.reduce((m,g) => Math.max(m, (g.special_teams && g.special_teams[field]) || 0), 0);
}

function compBar(label, valA, valB, unit='') {
    const max = Math.max(valA, valB, 1);
    const pctA = (valA/max*100).toFixed(0);
    const pctB = (valB/max*100).toFixed(0);
    return `
    <div class="glass rounded-xl p-4 mb-3">
        <div class="text-xs text-zinc-500 mb-2 text-center">${label}</div>
        <div class="flex items-center gap-3">
            <span class="text-sm font-bold team-a w-16 text-right">${valA}${unit}</span>
            <div class="flex-1 flex gap-1 h-6">
                <div class="flex-1 flex justify-end"><div class="team-a-bar rounded-l-md h-full" style="width:${pctA}%"></div></div>
                <div class="flex-1"><div class="team-b-bar rounded-r-md h-full" style="width:${pctB}%"></div></div>
            </div>
            <span class="text-sm font-bold team-b w-16">${valB}${unit}</span>
        </div>
    </div>`;
}

function statCard(label, value, sub, teamClass) {
    return `<div class="stat-card glass rounded-xl p-4 text-center">
        <div class="text-xs text-zinc-500">${label}</div>
        <div class="text-2xl font-bold ${teamClass} mt-1">${value}</div>
        ${sub ? `<div class="text-xs text-zinc-500 mt-1">${sub}</div>` : ''}
    </div>`;
}

function scheduleTable(team, games, teamClass) {
    let rows = games.map((g,i) => {
        const w = g.points_for > g.points_against;
        return `<tr class="schedule-row border-b border-white/5">
            <td class="py-2 px-3 text-xs text-zinc-400">${i+1}</td>
            <td class="py-2 px-3 text-sm">${g.opponent}</td>
            <td class="py-2 px-3 text-sm font-bold ${w ? 'text-green-400' : 'text-red-400'}">${w?'W':'L'} ${g.points_for}-${g.points_against}</td>
            <td class="py-2 px-3 text-xs text-zinc-400">${g.explosives} expl</td>
            <td class="py-2 px-3 text-xs text-zinc-400">${g.red_zone_tds}/${g.red_zone_trips} RZ</td>
        </tr>`;
    }).join('');
    return `<div class="glass rounded-xl overflow-hidden">
        <div class="px-4 py-3 border-b border-white/5"><span class="font-semibold ${teamClass}">${team.name}</span> <span class="text-zinc-500 text-sm">Schedule</span></div>
        <table class="w-full"><tbody>${rows}</tbody></table>
    </div>`;
}

function chartContainer(id, h='300px') {
    return `<div id="${id}" style="width:100%;height:${h}"></div>`;
}

function collapsible(title, count, content) {
    const uid = 'coll_' + Math.random().toString(36).substr(2,9);
    return `<div class="glass rounded-xl mt-4 overflow-hidden">
        <button onclick="document.getElementById('${uid}').classList.toggle('open');this.querySelector('.chevron').classList.toggle('open')" class="w-full px-4 py-3 flex items-center justify-between text-sm text-zinc-400 hover:text-zinc-200 transition">
            <span>${title} â€” ${count} plays</span>
            <svg class="chevron w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
        </button>
        <div id="${uid}" class="collapsible-body">${content}</div>
    </div>`;
}

// ===== TAB RENDERERS =====

function renderOverview() {
    const ga = DATA.teams.georgia, aa = DATA.teams.asu;
    const gf = filterGames(ga.games), af = filterGames(aa.games);
    const gs = agg(gf), as_ = agg(af);

    let html = `<div class="section-enter">`;
    html += `<div class="glass rounded-xl p-4 mb-4"><div class="text-sm text-zinc-400"><strong class="text-white">Note:</strong> This data includes only 4th down conversion attempts ("going for it"), not punts or field goals.</div></div>`;
    // Stat cards
    html += `<div class="grid grid-cols-2 gap-4 mb-6">
        <div class="grid grid-cols-2 gap-3">
            ${statCard('Record', gs.record, gs.ppg+' PPG', 'team-a')}
            ${statCard('TO Margin', gs.tom > 0 ? '+'+gs.tom : gs.tom, gs.tof+' forced', 'team-a')}
        </div>
        <div class="grid grid-cols-2 gap-3">
            ${statCard('Record', as_.record, as_.ppg+' PPG', 'team-b')}
            ${statCard('TO Margin', as_.tom > 0 ? '+'+as_.tom : as_.tom, as_.tof+' forced', 'team-b')}
        </div>
    </div>`;

    // Comparison bars
    html += compBar('Points Per Game', gs.ppg, as_.ppg);
    html += compBar('Opp PPG', gs.oppg, as_.oppg);
    html += compBar('Explosives/Game', gs.explpg, as_.explpg);
    html += compBar('Penalties/Game', gs.penpg, as_.penpg);
    html += compBar('RZ TD%', gs.rztdpct, as_.rztdpct, '%');

    // Points by game chart
    html += `<div class="glass rounded-xl p-4 mt-6">${chartContainer('ppgChart')}</div>`;

    // Schedule tables
    html += `<div class="grid grid-cols-2 gap-4 mt-6">
        ${scheduleTable(ga, gf, 'team-a')}
        ${scheduleTable(aa, af, 'team-b')}
    </div>`;
    html += `</div>`;
    return html;
}

function initOverviewCharts() {
    const ga = DATA.teams.georgia, aa = DATA.teams.asu;
    const gf = filterGames(ga.games), af = filterGames(aa.games);
    const c = echarts.init(document.getElementById('ppgChart'), 'dark');
    c.setOption({
        backgroundColor: 'transparent',
        tooltip: { 
            trigger: 'axis',
            formatter: (params) => {
                const i = params[0].dataIndex;
                const gGame = gf[i];
                const aGame = af[i];
                let tip = '';
                params.forEach(p => {
                    const g = p.seriesName === 'Georgia' ? gGame : aGame;
                    tip += `${p.marker} ${p.seriesName}: ${p.value}<br/>`;
                    if (g) tip += `vs ${g.opponent} ${g.date ? '(' + g.date + ')' : ''}<br/>`;
                });
                return tip;
            }
        },
        legend: { data: ['Georgia', 'Arizona State'], textStyle: { color: '#a1a1aa' } },
        xAxis: { type: 'category', data: gf.map((g,i) => 'G'+(i+1)), axisLabel: { color: '#71717a' } },
        yAxis: { type: 'value', axisLabel: { color: '#71717a' }, splitLine: { lineStyle: { color: 'rgba(255,255,255,0.05)' } } },
        series: [
            { name: 'Georgia', type: 'bar', data: gf.map(g => g.points_for), itemStyle: { color: '#ef4444' } },
            { name: 'Arizona State', type: 'bar', data: af.map(g => g.points_for), itemStyle: { color: '#f97316' } }
        ]
    });
    window.addEventListener('resize', () => c.resize());
}

function renderExplosives() {
    const ga = DATA.teams.georgia, aa = DATA.teams.asu;
    const gf = filterGames(ga.games), af = filterGames(aa.games);
    const gs = agg(gf), as_ = agg(af);

    let html = `<div class="section-enter">`;
    html += `<div class="glass rounded-xl p-4 mb-4"><div class="text-sm text-zinc-400"><strong class="text-white">Note:</strong> This data includes only 4th down conversion attempts ("going for it"), not punts or field goals.</div></div>`;
    html += `<div class="glass rounded-xl p-4 mb-4">
        <div class="text-sm text-zinc-300 font-medium">Definition</div>
        <div class="text-xs text-zinc-400 mt-1">Explosive plays: rushes of 15+ yards or passes of 20+ yards</div>
    </div>`;
    html += `<div class="grid grid-cols-2 gap-4 mb-6">
        ${statCard('Total Explosives', gs.expl, gs.explpg+'/game', 'team-a')}
        ${statCard('Total Explosives', as_.expl, as_.explpg+'/game', 'team-b')}
    </div>`;
    html += compBar('Explosives/Game', gs.explpg, as_.explpg);
    html += `<div class="glass rounded-xl p-4 mt-4">${chartContainer('explChart')}</div>`;

    // Helper to render explosive plays table with grouping
    const renderExplTable = (games, teamClass) => {
        const allExpl = games.flatMap((g,i) => (g.explosive_details||[]).map(e => ({...e, opponent: g.opponent, game: i+1})));
        if (!allExpl.length) return `<div class="text-zinc-500 text-xs p-4">No explosive plays found.</div>`;
        
        const rushPlays = allExpl.filter(e => e.type === 'rush');
        const passPlays = allExpl.filter(e => e.type === 'pass');
        
        let tbl = `<div class="space-y-3">`;
        if (rushPlays.length) {
            tbl += `<div><div class="text-xs font-semibold text-zinc-400 mb-2 px-2">Rush (${rushPlays.length} plays)</div>
            <table class="w-full text-xs"><thead class="sticky top-0 bg-zinc-900"><tr>
                <th class="py-2 px-2 text-left text-zinc-500">G#</th>
                <th class="py-2 px-2 text-left text-zinc-500">Opp</th>
                <th class="py-2 px-2 text-left text-zinc-500">Type</th>
                <th class="py-2 px-2 text-right text-zinc-500">Yds</th>
                <th class="py-2 px-2 text-left text-zinc-500">Description</th>
            </tr></thead><tbody>${rushPlays.map(e => `<tr class="border-b border-white/5 table-row">
                <td class="py-1 px-2 text-zinc-400">G${e.game}</td>
                <td class="py-1 px-2">${e.opponent||''}</td>
                <td class="py-1 px-2 text-green-400">Run</td>
                <td class="py-1 px-2 text-right font-bold">${e.yards||''}</td>
                <td class="py-1 px-2 text-zinc-400">${(e.description||'').substring(0,90)}</td>
            </tr>`).join('')}</tbody></table></div>`;
        }
        if (passPlays.length) {
            tbl += `<div><div class="text-xs font-semibold text-zinc-400 mb-2 px-2">Pass (${passPlays.length} plays)</div>
            <table class="w-full text-xs"><thead class="sticky top-0 bg-zinc-900"><tr>
                <th class="py-2 px-2 text-left text-zinc-500">G#</th>
                <th class="py-2 px-2 text-left text-zinc-500">Opp</th>
                <th class="py-2 px-2 text-left text-zinc-500">Type</th>
                <th class="py-2 px-2 text-right text-zinc-500">Yds</th>
                <th class="py-2 px-2 text-left text-zinc-500">Description</th>
            </tr></thead><tbody>${passPlays.map(e => `<tr class="border-b border-white/5 table-row">
                <td class="py-1 px-2 text-zinc-400">G${e.game}</td>
                <td class="py-1 px-2">${e.opponent||''}</td>
                <td class="py-1 px-2 text-blue-400">Pass</td>
                <td class="py-1 px-2 text-right font-bold">${e.yards||''}</td>
                <td class="py-1 px-2 text-zinc-400">${(e.description||'').substring(0,90)}</td>
            </tr>`).join('')}</tbody></table></div>`;
        }
        tbl += `</div>`;
        return tbl;
    };

    html += `<div class="grid grid-cols-2 gap-4 mt-4">
        ${collapsible('Georgia Explosive Plays', gf.reduce((sum,g) => sum + (g.explosive_details||[]).length, 0), renderExplTable(gf, 'team-a'))}
        ${collapsible('Arizona State Explosive Plays', af.reduce((sum,g) => sum + (g.explosive_details||[]).length, 0), renderExplTable(af, 'team-b'))}
    </div>`;
    html += `</div>`;
    return html;
}

function initExplosivesCharts() {
    const gf = filterGames(DATA.teams.georgia.games), af = filterGames(DATA.teams.asu.games);
    const c = echarts.init(document.getElementById('explChart'), 'dark');
    c.setOption({
        backgroundColor: 'transparent',
        tooltip: { 
            trigger: 'axis',
            formatter: (params) => {
                const i = params[0].dataIndex;
                const gGame = gf[i];
                const aGame = af[i];
                let tip = '';
                params.forEach(p => {
                    const g = p.seriesName === 'Georgia' ? gGame : aGame;
                    tip += `${p.marker} ${p.seriesName}: ${p.value}<br/>`;
                    if (g) tip += `vs ${g.opponent} ${g.date ? '(' + g.date + ')' : ''}<br/>`;
                });
                return tip;
            }
        },
        legend: { data: ['Georgia Rush', 'Georgia Pass', 'Arizona State Rush', 'Arizona State Pass'], textStyle: { color: '#a1a1aa' } },
        xAxis: { type: 'category', data: gf.map((g,i) => 'G'+(i+1)), axisLabel: { color: '#71717a' } },
        yAxis: { type: 'value', axisLabel: { color: '#71717a' }, splitLine: { lineStyle: { color: 'rgba(255,255,255,0.05)' } } },
        series: [
            { name: 'Georgia Rush', type: 'line', data: gf.map(g => g.explosive_rushes), itemStyle: { color: '#22c55e' }, lineStyle: { color: '#22c55e' }, smooth: true },
            { name: 'Georgia Pass', type: 'line', data: gf.map(g => g.explosive_passes), itemStyle: { color: '#3b82f6' }, lineStyle: { color: '#3b82f6' }, smooth: true },
            { name: 'Arizona State Rush', type: 'line', data: af.map(g => g.explosive_rushes), itemStyle: { color: '#22c55e' }, lineStyle: { color: '#22c55e', type: 'dashed' }, smooth: true },
            { name: 'Arizona State Pass', type: 'line', data: af.map(g => g.explosive_passes), itemStyle: { color: '#3b82f6' }, lineStyle: { color: '#3b82f6', type: 'dashed' }, smooth: true }
        ]
    });
    window.addEventListener('resize', () => c.resize());
}

function renderRedzone() {
    const ga = DATA.teams.georgia, aa = DATA.teams.asu;
    const gf = filterGames(ga.games), af = filterGames(aa.games);
    const gs = agg(gf), as_ = agg(af);

    const renderZoneSection = (zoneName, zoneDesc, gStats, aStats, zoneKey, games_g, games_a) => {
        const gTrips = gStats[`${zoneKey}_trips`] || 0;
        const gTds = gStats[`${zoneKey}_tds`] || 0;
        const gFgs = gStats[`${zoneKey}_fgs`] || 0;
        const gFailed = gStats[`${zoneKey}_failed`] || 0;
        const gTdPct = gTrips > 0 ? ((gTds / gTrips) * 100).toFixed(1) : '0.0';
        const gScorePct = gTrips > 0 ? (((gTds + gFgs) / gTrips) * 100).toFixed(1) : '0.0';

        const aTrips = aStats[`${zoneKey}_trips`] || 0;
        const aTds = aStats[`${zoneKey}_tds`] || 0;
        const aFgs = aStats[`${zoneKey}_fgs`] || 0;
        const aFailed = aStats[`${zoneKey}_failed`] || 0;
        const aTdPct = aTrips > 0 ? ((aTds / aTrips) * 100).toFixed(1) : '0.0';
        const aScorePct = aTrips > 0 ? (((aTds + aFgs) / aTrips) * 100).toFixed(1) : '0.0';

        let html = `<div class="mb-6">`;
        html += `<h3 class="text-lg font-bold text-white mb-3">${zoneName} <span class="text-zinc-500 text-sm font-normal">${zoneDesc}</span></h3>`;
        html += `<div class="grid grid-cols-2 gap-4 mb-4">
            <div class="grid grid-cols-4 gap-3">
                ${statCard('Trips', gTrips, '', 'team-a')}
                ${statCard('TDs', gTds, gTdPct+'%', 'team-a')}
                ${statCard('FGs', gFgs, '', 'team-a')}
                ${statCard('Failed', gFailed, '', 'team-a')}
            </div>
            <div class="grid grid-cols-4 gap-3">
                ${statCard('Trips', aTrips, '', 'team-b')}
                ${statCard('TDs', aTds, aTdPct+'%', 'team-b')}
                ${statCard('FGs', aFgs, '', 'team-b')}
                ${statCard('Failed', aFailed, '', 'team-b')}
            </div>
        </div>`;
        html += compBar('TD Rate', parseFloat(gTdPct), parseFloat(aTdPct), '%');
        html += compBar('Score Rate', parseFloat(gScorePct), parseFloat(aScorePct), '%');

        // Collapsible play table
        const tableId = `${zoneKey}Table`;
        html += `<details class="mt-4 glass rounded-xl">
            <summary class="cursor-pointer p-3 text-sm font-medium text-white hover:bg-white/5">
                Show ${zoneName} Play Details
            </summary>
            <div class="p-4 pt-0">
                <div class="grid grid-cols-2 gap-4">`;

        const renderZonePlayTable = (games, teamName) => {
            const zonePlays = games.flatMap(g => {
                const plays = (g.red_zone_plays || []).filter(p => {
                    if (zoneKey === 'green_zone') return p.yards_to_goal <= 30;
                    if (zoneKey === 'red_zone') return p.yards_to_goal <= 20;
                    if (zoneKey === 'tight_red_zone') return p.yards_to_goal <= 10;
                    return false;
                });
                return plays.map(p => ({...p, game: g.game_number, opponent: g.opponent}));
            });

            if (!zonePlays.length) return `<div class="text-zinc-500 text-xs p-4">No plays in ${zoneName.toLowerCase()}</div>`;

            return `<table class="w-full text-xs"><thead class="sticky top-0 bg-zinc-900"><tr>
                <th class="py-2 px-2 text-left text-zinc-500">G#</th>
                <th class="py-2 px-2 text-left text-zinc-500">Opp</th>
                <th class="py-2 px-2 text-left text-zinc-500">Q</th>
                <th class="py-2 px-2 text-left text-zinc-500">Clock</th>
                <th class="py-2 px-2 text-left text-zinc-500">Down</th>
                <th class="py-2 px-2 text-left text-zinc-500">YTG</th>
                <th class="py-2 px-2 text-left text-zinc-500">Type</th>
                <th class="py-2 px-2 text-left text-zinc-500">Yds</th>
                <th class="py-2 px-2 text-left text-zinc-500">Score</th>
                <th class="py-2 px-2 text-left text-zinc-500">Description</th>
            </tr></thead><tbody>${zonePlays.map(p => `<tr class="border-t border-white/5 hover:bg-white/5">
                <td class="py-2 px-2">${p.game}</td>
                <td class="py-2 px-2">${p.opponent}</td>
                <td class="py-2 px-2">${p.quarter}</td>
                <td class="py-2 px-2">${p.clock}</td>
                <td class="py-2 px-2">${p.down_distance}</td>
                <td class="py-2 px-2">${p.yards_to_goal}</td>
                <td class="py-2 px-2">${p.play_type}</td>
                <td class="py-2 px-2">${p.yards}</td>
                <td class="py-2 px-2">${p.scoring ? 'âœ…' : ''}</td>
                <td class="py-2 px-2 text-zinc-400">${p.description}</td>
            </tr>`).join('')}</tbody></table>`;
        };

        html += `<div><h4 class="text-sm font-medium text-white mb-2">${ga.name}</h4>${renderZonePlayTable(games_g, ga.name)}</div>`;
        html += `<div><h4 class="text-sm font-medium text-white mb-2">${aa.name}</h4>${renderZonePlayTable(games_a, aa.name)}</div>`;
        html += `</div></div></details>`;
        html += `</div>`;
        return html;
    };

    let html = `<div class="section-enter">`;
    html += `<div class="glass rounded-xl p-4 mb-4"><div class="text-sm text-zinc-400"><strong class="text-white">Note:</strong> This data includes only 4th down conversion attempts ("going for it"), not punts or field goals.</div></div>`;
    html += renderZoneSection('Green Zone', '(30 yards & in)', gs, as_, 'green_zone', gf, af);
    html += `<div class="border-t-2 border-zinc-700 my-6"></div>`;
    html += renderZoneSection('Red Zone', '(20 yards & in)', gs, as_, 'red_zone', gf, af);
    html += `<div class="border-t-2 border-zinc-700 my-6"></div>`;
    html += renderZoneSection('Tight Red Zone', '(10 yards & in)', gs, as_, 'tight_red_zone', gf, af);
    html += `</div>`;
    return html;
}

function initRedzoneCharts() {
    const gs = agg(filterGames(DATA.teams.georgia.games));
    const as_ = agg(filterGames(DATA.teams.asu.games));
    const noScore = (s) => Math.max(0, s.rzt - s.rztd - s.rzfg);
    [['rzChartA', gs, '#ef4444', 'Georgia'], ['rzChartB', as_, '#f97316', 'Arizona State']].forEach(([id, s, col, name]) => {
        const c = echarts.init(document.getElementById(id), 'dark');
        c.setOption({
            backgroundColor: 'transparent',
            title: { text: name, left: 'center', textStyle: { color: '#a1a1aa', fontSize: 13 } },
            tooltip: { trigger: 'item' },
            series: [{ type: 'pie', radius: ['40%','70%'], data: [
                { value: s.rztd, name: 'TD', itemStyle: { color: '#22c55e' } },
                { value: s.rzfg, name: 'FG', itemStyle: { color: '#eab308' } },
                { value: noScore(s), name: 'No Score', itemStyle: { color: '#71717a' } },
            ], label: { color: '#a1a1aa', fontSize: 11 } }]
        });
        window.addEventListener('resize', () => c.resize());
    });
}

function renderTurnovers() {
    const gf = filterGames(DATA.teams.georgia.games), af = filterGames(DATA.teams.asu.games);
    const gs = agg(gf), as_ = agg(af);
    const gIntLost = sumField(gf, 'interceptions_lost');
    const gIntGained = sumField(gf, 'interceptions_gained');
    const gFumLost = sumField(gf, 'fumbles_lost');
    const gFumGained = sumField(gf, 'fumbles_gained');
    const aIntLost = sumField(af, 'interceptions_lost');
    const aIntGained = sumField(af, 'interceptions_gained');
    const aFumLost = sumField(af, 'fumbles_lost');
    const aFumGained = sumField(af, 'fumbles_gained');
    let html = `<div class="section-enter">`;
    html += `<div class="glass rounded-xl p-4 mb-4"><div class="text-sm text-zinc-400"><strong class="text-white">Note:</strong> This data includes only 4th down conversion attempts ("going for it"), not punts or field goals.</div></div>`;
    html += `<div class="grid grid-cols-2 gap-4 mb-6">
        ${statCard('TO Margin', gs.tom>0?'+'+gs.tom:gs.tom, gs.tof+' forced / '+gs.tol+' lost', 'team-a')}
        ${statCard('TO Margin', as_.tom>0?'+'+as_.tom:as_.tom, as_.tof+' forced / '+as_.tol+' lost', 'team-b')}
    </div>`;
    html += `<div class="grid grid-cols-2 gap-4 mb-6">
        <div class="grid grid-cols-4 gap-3">
            ${statCard('INT Gained', gIntGained, '', 'team-a')}
            ${statCard('INT Lost', gIntLost, '', 'team-a')}
            ${statCard('Fum Gained', gFumGained, '', 'team-a')}
            ${statCard('Fum Lost', gFumLost, '', 'team-a')}
        </div>
        <div class="grid grid-cols-4 gap-3">
            ${statCard('INT Gained', aIntGained, '', 'team-b')}
            ${statCard('INT Lost', aIntLost, '', 'team-b')}
            ${statCard('Fum Gained', aFumGained, '', 'team-b')}
            ${statCard('Fum Lost', aFumLost, '', 'team-b')}
        </div>
    </div>`;
    html += compBar('Turnovers Forced', gs.tof, as_.tof);
    html += compBar('Turnovers Lost', gs.tol, as_.tol);
    html += `<div class="glass rounded-xl p-4 mt-4">${chartContainer('toChart')}</div>`;
    html += `<div class="grid grid-cols-2 gap-4 mt-4">
        <div class="glass rounded-xl p-4">${chartContainer('toSplitGained', '260px')}</div>
        <div class="glass rounded-xl p-4">${chartContainer('toSplitLost', '260px')}</div>
    </div>`;

    // Turnover play details
    const renderTurnoverTable = (games, teamClass) => {
        const toPlays = games.flatMap((g,idx) => {
            return (g.play_tree||[]).flatMap(q => 
                q.drives.flatMap(d => 
                    d.plays.filter(p => p.is_turnover)
                        .map(p => ({...p, game: g.game_number, opponent: g.opponent}))
                )
            );
        });
        if (!toPlays.length) return `<div class="text-zinc-500 text-xs p-4">No turnover plays found.</div>`;
        return `<table class="w-full text-xs"><thead class="sticky top-0 bg-zinc-900"><tr>
            <th class="py-2 px-2 text-left text-zinc-500">G#</th>
            <th class="py-2 px-2 text-left text-zinc-500">Opponent</th>
            <th class="py-2 px-2 text-left text-zinc-500">Quarter</th>
            <th class="py-2 px-2 text-left text-zinc-500">Clock</th>
            <th class="py-2 px-2 text-left text-zinc-500">Down/Dist</th>
            <th class="py-2 px-2 text-left text-zinc-500">Spot</th>
            <th class="py-2 px-2 text-left text-zinc-500">Team</th>
            <th class="py-2 px-2 text-left text-zinc-500">Description</th>
        </tr></thead><tbody>${toPlays.map(p => `<tr class="border-b border-white/5 table-row">
            <td class="py-1 px-2 text-zinc-400">G${p.game}</td>
            <td class="py-1 px-2">${p.opponent||''}</td>
            <td class="py-1 px-2">${p.quarter}</td>
            <td class="py-1 px-2 text-zinc-400">${p.clock||''}</td>
            <td class="py-1 px-2 text-zinc-400">${p.down_distance||''}</td>
            <td class="py-1 px-2 text-zinc-400">${p.spot||''}</td>
            <td class="py-1 px-2 ${teamClass}">${p.offense||''}</td>
            <td class="py-1 px-2 text-zinc-300">${(p.description||'').substring(0,120)}</td>
        </tr>`).join('')}</tbody></table>`;
    };

    html += `<div class="grid grid-cols-2 gap-4 mt-4">
        ${collapsible('Georgia Turnover Plays', gf.flatMap(g => (g.play_tree||[]).flatMap(q => q.drives.flatMap(d => d.plays.filter(p => p.is_turnover)))).length, renderTurnoverTable(gf, 'team-a'))}
        ${collapsible('Arizona State Turnover Plays', af.flatMap(g => (g.play_tree||[]).flatMap(q => q.drives.flatMap(d => d.plays.filter(p => p.is_turnover)))).length, renderTurnoverTable(af, 'team-b'))}
    </div>`;

    html += `</div>`;
    return html;
}

function initTurnoverCharts() {
    const gf = filterGames(DATA.teams.georgia.games), af = filterGames(DATA.teams.asu.games);
    const c = echarts.init(document.getElementById('toChart'), 'dark');
    const gIntLost = sumField(gf, 'interceptions_lost');
    const gIntGained = sumField(gf, 'interceptions_gained');
    const gFumLost = sumField(gf, 'fumbles_lost');
    const gFumGained = sumField(gf, 'fumbles_gained');
    const aIntLost = sumField(af, 'interceptions_lost');
    const aIntGained = sumField(af, 'interceptions_gained');
    const aFumLost = sumField(af, 'fumbles_lost');
    const aFumGained = sumField(af, 'fumbles_gained');
    c.setOption({
        backgroundColor: 'transparent',
        tooltip: { 
            trigger: 'axis',
            formatter: (params) => {
                const i = params[0].dataIndex;
                const gGame = gf[i];
                const aGame = af[i];
                let tip = '';
                params.forEach(p => {
                    const g = p.seriesName.includes('Georgia') ? gGame : aGame;
                    tip += `${p.marker} ${p.seriesName}: ${p.value}<br/>`;
                    if (g) tip += `vs ${g.opponent} ${g.date ? '(' + g.date + ')' : ''}<br/>`;
                });
                return tip;
            }
        },
        legend: { data: ['Georgia TO Margin', 'ASU TO Margin'], textStyle: { color: '#a1a1aa' } },
        xAxis: { type: 'category', data: gf.map((g,i) => 'G'+(i+1)), axisLabel: { color: '#71717a' } },
        yAxis: { type: 'value', axisLabel: { color: '#71717a' }, splitLine: { lineStyle: { color: 'rgba(255,255,255,0.05)' } } },
        series: [
            { name: 'Georgia TO Margin', type: 'bar', data: gf.map(g => g.turnovers_gained - g.turnovers_lost), itemStyle: { color: '#ef4444' } },
            { name: 'ASU TO Margin', type: 'bar', data: af.map(g => g.turnovers_gained - g.turnovers_lost), itemStyle: { color: '#f97316' } },
        ]
    });
    const cGained = echarts.init(document.getElementById('toSplitGained'), 'dark');
    cGained.setOption({
        backgroundColor: 'transparent',
        tooltip: { trigger: 'axis' },
        legend: { data: ['INTs', 'Fumbles'], textStyle: { color: '#a1a1aa' } },
        grid: { left: 30, right: 20, top: 30, bottom: 30, containLabel: true },
        xAxis: { type: 'category', data: ['Georgia', 'ASU'], axisLabel: { color: '#71717a' } },
        yAxis: { type: 'value', axisLabel: { color: '#71717a' }, splitLine: { lineStyle: { color: 'rgba(255,255,255,0.05)' } } },
        series: [
            { name: 'INTs', type: 'bar', stack: 'gained', data: [gIntGained, aIntGained], itemStyle: { color: '#60a5fa' } },
            { name: 'Fumbles', type: 'bar', stack: 'gained', data: [gFumGained, aFumGained], itemStyle: { color: '#34d399' } },
        ]
    });
    const cLost = echarts.init(document.getElementById('toSplitLost'), 'dark');
    cLost.setOption({
        backgroundColor: 'transparent',
        tooltip: { trigger: 'axis' },
        legend: { data: ['INTs', 'Fumbles'], textStyle: { color: '#a1a1aa' } },
        grid: { left: 30, right: 20, top: 30, bottom: 30, containLabel: true },
        xAxis: { type: 'category', data: ['Georgia', 'ASU'], axisLabel: { color: '#71717a' } },
        yAxis: { type: 'value', axisLabel: { color: '#71717a' }, splitLine: { lineStyle: { color: 'rgba(255,255,255,0.05)' } } },
        series: [
            { name: 'INTs', type: 'bar', stack: 'lost', data: [gIntLost, aIntLost], itemStyle: { color: '#93c5fd' } },
            { name: 'Fumbles', type: 'bar', stack: 'lost', data: [gFumLost, aFumLost], itemStyle: { color: '#86efac' } },
        ]
    });
    window.addEventListener('resize', () => {
        c.resize();
        cGained.resize();
        cLost.resize();
    });
}

function renderPostTurnover() {
    const ga = DATA.teams.georgia, aa = DATA.teams.asu;
    const gf = filterGames(ga.games), af = filterGames(aa.games);
    const gs = agg(gf), as_ = agg(af);

    const gPointsOff = sumField(gf, 'points_off_turnovers_for');
    const aPointsOff = sumField(af, 'points_off_turnovers_for');
    const gPointsAllowed = sumField(gf, 'points_off_turnovers_against');
    const aPointsAllowed = sumField(af, 'points_off_turnovers_against');

    let html = `<div class="section-enter">`;
    html += `<div class="glass rounded-xl p-4 mb-4"><div class="text-sm text-zinc-400"><strong class="text-white">Note:</strong> This data includes only 4th down conversion attempts ("going for it"), not punts or field goals.</div></div>`;
    html += `<div class="grid grid-cols-2 gap-4 mb-6">
        <div class="grid grid-cols-3 gap-3">
            ${statCard('TO Gained', gs.tof, '', 'team-a')}
            ${statCard('TO Lost', gs.tol, '', 'team-a')}
            ${statCard('Pts Off TO', gPointsOff, '', 'team-a')}
        </div>
        <div class="grid grid-cols-3 gap-3">
            ${statCard('TO Gained', as_.tof, '', 'team-b')}
            ${statCard('TO Lost', as_.tol, '', 'team-b')}
            ${statCard('Pts Off TO', aPointsOff, '', 'team-b')}
        </div>
    </div>`;
    
    html += compBar('Points Off Turnovers', gPointsOff, aPointsOff);
    html += compBar('Points Allowed After TO', gPointsAllowed, aPointsAllowed);
    html += `<div class="grid grid-cols-2 gap-4 mt-4">
        <div class="glass rounded-xl p-4">${chartContainer('postToTotalsChart', '260px')}</div>
        <div class="glass rounded-xl p-4">${chartContainer('postToPerGameChart', '260px')}</div>
    </div>`;

    // Post-turnover drive tables
    const renderPostTurnoverTable = (games, teamName, ourTeam) => {
        const drives = games.flatMap(g => {
            return (g.post_turnover_drives || []).map(d => ({...d, game: g.game_number, opponent: g.opponent}));
        });

        if (!drives.length) return `<div class="text-zinc-500 text-xs p-4">No post-turnover drives recorded.</div>`;

        return `<table class="w-full text-xs"><thead class="sticky top-0 bg-zinc-900"><tr>
            <th class="py-2 px-2 text-left text-zinc-500">G#</th>
            <th class="py-2 px-2 text-left text-zinc-500">Opponent</th>
            <th class="py-2 px-2 text-left text-zinc-500">Q</th>
            <th class="py-2 px-2 text-left text-zinc-500">Clock</th>
            <th class="py-2 px-2 text-left text-zinc-500">Type</th>
            <th class="py-2 px-2 text-left text-zinc-500">Lost By</th>
            <th class="py-2 px-2 text-left text-zinc-500">Recovered By</th>
            <th class="py-2 px-2 text-left text-zinc-500">Result</th>
            <th class="py-2 px-2 text-left text-zinc-500">Points</th>
            <th class="py-2 px-2 text-left text-zinc-500">Description</th>
        </tr></thead><tbody>${drives.map(d => `<tr class="border-t border-white/5 hover:bg-white/5">
            <td class="py-2 px-2">${d.game}</td>
            <td class="py-2 px-2">${d.opponent}</td>
            <td class="py-2 px-2">${d.quarter}</td>
            <td class="py-2 px-2">${d.clock}</td>
            <td class="py-2 px-2">${d.turnover_type}</td>
            <td class="py-2 px-2">${d.lost_by}</td>
            <td class="py-2 px-2">${d.recovered_by}</td>
            <td class="py-2 px-2">${d.drive_result}</td>
            <td class="py-2 px-2">${d.points_scored || 0}</td>
            <td class="py-2 px-2 text-zinc-400">${d.turnover_description}</td>
        </tr>`).join('')}</tbody></table>`;
    };

    html += `<div class="grid grid-cols-2 gap-4 mt-4">
        <div class="glass rounded-xl p-4">
            <h4 class="text-sm font-medium text-white mb-2">${ga.name} Post-Turnover Drives</h4>
            ${renderPostTurnoverTable(gf, ga.name, 'UGA')}
        </div>
        <div class="glass rounded-xl p-4">
            <h4 class="text-sm font-medium text-white mb-2">${aa.name} Post-Turnover Drives</h4>
            ${renderPostTurnoverTable(af, aa.name, 'ASU')}
        </div>
    </div>`;

    html += `</div>`;
    return html;
}

function initPostTurnoverCharts() {
    const ga = DATA.teams.georgia, aa = DATA.teams.asu;
    const gf = filterGames(ga.games), af = filterGames(aa.games);
    const gPointsOff = sumField(gf, 'points_off_turnovers_for');
    const aPointsOff = sumField(af, 'points_off_turnovers_for');
    const gPointsAllowed = sumField(gf, 'points_off_turnovers_against');
    const aPointsAllowed = sumField(af, 'points_off_turnovers_against');
    const totalsChart = echarts.init(document.getElementById('postToTotalsChart'), 'dark');
    totalsChart.setOption({
        backgroundColor: 'transparent',
        tooltip: { trigger: 'axis' },
        legend: { data: ['Points Off TO', 'Points Allowed'], textStyle: { color: '#a1a1aa' } },
        grid: { left: 30, right: 20, top: 30, bottom: 30, containLabel: true },
        xAxis: { type: 'category', data: [ga.name, aa.name], axisLabel: { color: '#71717a' } },
        yAxis: { type: 'value', axisLabel: { color: '#71717a' }, splitLine: { lineStyle: { color: 'rgba(255,255,255,0.05)' } } },
        series: [
            { name: 'Points Off TO', type: 'bar', stack: 'total', data: [gPointsOff, aPointsOff], itemStyle: { color: '#ef4444' } },
            { name: 'Points Allowed', type: 'bar', stack: 'total', data: [gPointsAllowed, aPointsAllowed], itemStyle: { color: '#64748b' } },
        ]
    });
    const perGameChart = echarts.init(document.getElementById('postToPerGameChart'), 'dark');
    perGameChart.setOption({
        backgroundColor: 'transparent',
        tooltip: { trigger: 'axis' },
        legend: { data: ['UGA For', 'UGA Allowed', 'ASU For', 'ASU Allowed'], textStyle: { color: '#a1a1aa' } },
        grid: { left: 30, right: 20, top: 30, bottom: 30, containLabel: true },
        xAxis: { type: 'category', data: gf.map((g,i) => 'G'+(i+1)), axisLabel: { color: '#71717a' } },
        yAxis: { type: 'value', axisLabel: { color: '#71717a' }, splitLine: { lineStyle: { color: 'rgba(255,255,255,0.05)' } } },
        series: [
            { name: 'UGA For', type: 'bar', data: gf.map(g => g.points_off_turnovers_for || 0), itemStyle: { color: '#ef4444' } },
            { name: 'UGA Allowed', type: 'bar', data: gf.map(g => g.points_off_turnovers_against || 0), itemStyle: { color: '#fca5a5' } },
            { name: 'ASU For', type: 'bar', data: af.map(g => g.points_off_turnovers_for || 0), itemStyle: { color: '#f97316' } },
            { name: 'ASU Allowed', type: 'bar', data: af.map(g => g.points_off_turnovers_against || 0), itemStyle: { color: '#fdba74' } },
        ]
    });
    window.addEventListener('resize', () => {
        totalsChart.resize();
        perGameChart.resize();
    });
}

function renderPenalties() {
    const gf = filterGames(DATA.teams.georgia.games), af = filterGames(DATA.teams.asu.games);
    const gs = agg(gf), as_ = agg(af);
    const ga = DATA.teams.georgia, aa = DATA.teams.asu;
    const getPenaltyDetails = (games) => games.flatMap(g => (g.penalty_details || []).map(p => ({
        ...p,
        game: g.game_number,
        opponent: g.opponent
    })));
    const gaDetails = getPenaltyDetails(gf).filter(p => p.team === ga.abbr);
    const aaDetails = getPenaltyDetails(af).filter(p => p.team === aa.abbr);
    const extractPenaltyNames = (desc) => {
        if (!desc || typeof desc !== 'string') return [];
        const penaltyIdx = desc.toUpperCase().indexOf('PENALTY');
        const searchText = penaltyIdx >= 0 ? desc.slice(penaltyIdx) : desc;
        const matches = [];
        let m;
        const re = /\(([^)]+)\)/g;
        while ((m = re.exec(searchText)) !== null) {
            matches.push(m[1]);
        }
        if (!matches.length) return [];
        return matches.flatMap(chunk => chunk.split(/\/|&| and |;|\|/i))
            .map(part => part.trim())
            .filter(part => /[a-z]/i.test(part))
            .map(part => {
                if (part.includes(',')) {
                    const parts = part.split(',').map(s => s.trim()).filter(Boolean);
                    if (parts.length >= 2) return `${parts[1]} ${parts[0]}`.trim();
                }
                return part;
            })
            .filter(name => name.length >= 3);
    };
    const renderOffenders = (details, teamClass) => {
        const counts = {};
        details.forEach(p => {
            extractPenaltyNames(p.description).forEach(name => {
                counts[name] = (counts[name] || 0) + 1;
            });
        });
        const top = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0,5);
        if (!top.length) return `<div class="text-zinc-500 text-xs p-4">No player penalties found.</div>`;
        return `<div class="space-y-2">
            ${top.map((t,i) => `<div class="flex items-center justify-between text-sm">
                <span class="${teamClass}">${i+1}. ${t[0]}</span>
                <span class="text-zinc-500">${t[1]}</span>
            </div>`).join('')}
        </div>`;
    };

    let html = `<div class="section-enter">`;
    html += `<div class="glass rounded-xl p-4 mb-4"><div class="text-sm text-zinc-400"><strong class="text-white">Note:</strong> This data includes only 4th down conversion attempts ("going for it"), not punts or field goals.</div></div>`;
    html += `<div class="grid grid-cols-2 gap-4 mb-6">
        ${statCard('Penalties/Game', gs.penpg, gs.pen+' total', 'team-a')}
        ${statCard('Penalties/Game', as_.penpg, as_.pen+' total', 'team-b')}
    </div>`;
    html += compBar('Penalties/Game', gs.penpg, as_.penpg);
    html += `<div class="glass rounded-xl p-4 mt-4">${chartContainer('penChart')}</div>`;
    html += `<div class="grid grid-cols-2 gap-4 mt-4">
        <div class="glass rounded-xl p-4">${chartContainer('penTypeChart')}</div>
        <div class="glass rounded-xl p-4">${chartContainer('penAcceptChart', '260px')}</div>
    </div>`;
    html += `<div class="grid grid-cols-2 gap-4 mt-4">
        <div class="glass rounded-xl p-4">
            <div class="text-sm font-medium text-white mb-3">${ga.name} Biggest Offenders</div>
            ${renderOffenders(gaDetails, 'team-a')}
        </div>
        <div class="glass rounded-xl p-4">
            <div class="text-sm font-medium text-white mb-3">${aa.name} Biggest Offenders</div>
            ${renderOffenders(aaDetails, 'team-b')}
        </div>
    </div>`;

    // Penalty play details
    const renderPenaltyTable = (games, teamClass) => {
        const penPlays = games.flatMap((g,idx) => {
            return (g.play_tree||[]).flatMap(q => 
                q.drives.flatMap(d => 
                    d.plays.filter(p => (p.description||'').toUpperCase().includes('PENALTY'))
                        .map(p => ({...p, game: g.game_number, opponent: g.opponent}))
                )
            );
        });
        if (!penPlays.length) return `<div class="text-zinc-500 text-xs p-4">No penalty plays found.</div>`;
        return `<table class="w-full text-xs"><thead class="sticky top-0 bg-zinc-900"><tr>
            <th class="py-2 px-2 text-left text-zinc-500">G#</th>
            <th class="py-2 px-2 text-left text-zinc-500">Opponent</th>
            <th class="py-2 px-2 text-left text-zinc-500">Quarter</th>
            <th class="py-2 px-2 text-left text-zinc-500">Clock</th>
            <th class="py-2 px-2 text-left text-zinc-500">Down/Dist</th>
            <th class="py-2 px-2 text-left text-zinc-500">Spot</th>
            <th class="py-2 px-2 text-left text-zinc-500">Description</th>
        </tr></thead><tbody>${penPlays.map(p => `<tr class="border-b border-white/5 table-row">
            <td class="py-1 px-2 text-zinc-400">G${p.game}</td>
            <td class="py-1 px-2">${p.opponent||''}</td>
            <td class="py-1 px-2">${p.quarter}</td>
            <td class="py-1 px-2 text-zinc-400">${p.clock||''}</td>
            <td class="py-1 px-2 text-zinc-400">${p.down_distance||''}</td>
            <td class="py-1 px-2 text-zinc-400">${p.spot||''}</td>
            <td class="py-1 px-2 text-zinc-300">${(p.description||'').substring(0,120)}</td>
        </tr>`).join('')}</tbody></table>`;
    };

    html += `<div class="grid grid-cols-2 gap-4 mt-4">
        ${collapsible('Georgia Penalty Plays', gf.flatMap(g => (g.play_tree||[]).flatMap(q => q.drives.flatMap(d => d.plays.filter(p => (p.description||'').toUpperCase().includes('PENALTY'))))).length, renderPenaltyTable(gf, 'team-a'))}
        ${collapsible('Arizona State Penalty Plays', af.flatMap(g => (g.play_tree||[]).flatMap(q => q.drives.flatMap(d => d.plays.filter(p => (p.description||'').toUpperCase().includes('PENALTY'))))).length, renderPenaltyTable(af, 'team-b'))}
    </div>`;

    html += `</div>`;
    return html;
}

function initPenaltyCharts() {
    const gf = filterGames(DATA.teams.georgia.games), af = filterGames(DATA.teams.asu.games);
    const ga = DATA.teams.georgia, aa = DATA.teams.asu;
    const getPenaltyDetails = (games) => games.flatMap(g => (g.penalty_details || []).map(p => ({
        ...p,
        game: g.game_number,
        opponent: g.opponent
    })));
    const classifyPenalty = (p) => {
        const text = `${p.type || ''} ${p.description || ''}`.toLowerCase();
        if (text.includes('pass interference') || /\b(dpi|opi)\b/.test(text)) return 'Pass Interference';
        if (text.includes('holding')) return 'Holding';
        if (text.includes('false start')) return 'False Start';
        if (text.includes('offside')) return 'Offsides/Offside';
        if (text.includes('illegal formation')) return 'Illegal Formation';
        if (text.includes('unsportsmanlike')) return 'Unsportsmanlike';
        return 'Other';
    };
    const gaDetails = getPenaltyDetails(gf).filter(p => p.team === ga.abbr);
    const aaDetails = getPenaltyDetails(af).filter(p => p.team === aa.abbr);
    const typeBuckets = ['Pass Interference', 'Holding', 'False Start', 'Offsides/Offside', 'Illegal Formation', 'Unsportsmanlike', 'Other'];
    const countByType = (details) => details.reduce((acc, p) => {
        const bucket = classifyPenalty(p);
        acc[bucket] = (acc[bucket] || 0) + 1;
        return acc;
    }, {});
    const gaTypeCounts = countByType(gaDetails);
    const aaTypeCounts = countByType(aaDetails);

    const c = echarts.init(document.getElementById('penChart'), 'dark');
    c.setOption({
        backgroundColor: 'transparent',
        tooltip: { 
            trigger: 'axis',
            formatter: (params) => {
                const i = params[0].dataIndex;
                const gGame = gf[i];
                const aGame = af[i];
                let tip = '';
                params.forEach(p => {
                    const g = p.seriesName === 'Georgia' ? gGame : aGame;
                    tip += `${p.marker} ${p.seriesName}: ${p.value}<br/>`;
                    if (g) tip += `vs ${g.opponent} ${g.date ? '(' + g.date + ')' : ''}<br/>`;
                });
                return tip;
            }
        },
        legend: { data: ['Georgia', 'Arizona State'], textStyle: { color: '#a1a1aa' } },
        xAxis: { type: 'category', data: gf.map((g,i) => 'G'+(i+1)), axisLabel: { color: '#71717a' } },
        yAxis: { type: 'value', axisLabel: { color: '#71717a' }, splitLine: { lineStyle: { color: 'rgba(255,255,255,0.05)' } } },
        series: [
            { name: 'Georgia', type: 'line', data: gf.map(g => g.penalties), itemStyle: { color: '#ef4444' }, smooth: true, areaStyle: { color: 'rgba(239,68,68,0.1)' } },
            { name: 'Arizona State', type: 'line', data: af.map(g => g.penalties), itemStyle: { color: '#f97316' }, smooth: true, areaStyle: { color: 'rgba(249,115,22,0.1)' } },
        ]
    });
    const typeChartEl = document.getElementById('penTypeChart');
    const typeChart = typeChartEl ? echarts.init(typeChartEl, 'dark') : null;
    if (typeChart) {
        typeChart.setOption({
            backgroundColor: 'transparent',
            tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
            legend: { data: [ga.name, aa.name], textStyle: { color: '#a1a1aa' } },
            grid: { left: '3%', right: '3%', bottom: '3%', containLabel: true },
            xAxis: { type: 'value', axisLabel: { color: '#71717a' }, splitLine: { lineStyle: { color: 'rgba(255,255,255,0.05)' } } },
            yAxis: { type: 'category', data: typeBuckets, axisLabel: { color: '#71717a' } },
            series: [
                { name: ga.name, type: 'bar', data: typeBuckets.map(t => gaTypeCounts[t] || 0), itemStyle: { color: '#ef4444' } },
                { name: aa.name, type: 'bar', data: typeBuckets.map(t => aaTypeCounts[t] || 0), itemStyle: { color: '#f97316' } },
            ]
        });
    }
    const acceptEl = document.getElementById('penAcceptChart');
    const acceptChart = acceptEl ? echarts.init(acceptEl, 'dark') : null;
    if (acceptChart) {
        const gaAccepted = gaDetails.filter(p => p.accepted).length;
        const gaDeclined = gaDetails.length - gaAccepted;
        const aaAccepted = aaDetails.filter(p => p.accepted).length;
        const aaDeclined = aaDetails.length - aaAccepted;
        acceptChart.setOption({
            backgroundColor: 'transparent',
            tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
            legend: { data: ['Accepted', 'Declined'], textStyle: { color: '#a1a1aa' } },
            grid: { left: '3%', right: '3%', bottom: '3%', containLabel: true },
            xAxis: { type: 'category', data: [ga.name, aa.name], axisLabel: { color: '#71717a' } },
            yAxis: { type: 'value', axisLabel: { color: '#71717a' }, splitLine: { lineStyle: { color: 'rgba(255,255,255,0.05)' } } },
            series: [
                { name: 'Accepted', type: 'bar', stack: 'total', data: [gaAccepted, aaAccepted], itemStyle: { color: '#22c55e' } },
                { name: 'Declined', type: 'bar', stack: 'total', data: [gaDeclined, aaDeclined], itemStyle: { color: '#ef4444' } },
            ]
        });
    }
    const charts = [c, typeChart, acceptChart].filter(Boolean);
    window.addEventListener('resize', () => charts.forEach(ch => ch.resize()));
}

function renderSimpleTab(title, msg) {
    return `<div class="section-enter"><div class="glass rounded-xl p-8 text-center">
        <div class="text-2xl mb-2">${title}</div>
        <div class="text-zinc-500">${msg}</div>
    </div></div>`;
}

function renderMiddle8() {
    const ga = DATA.teams.georgia, aa = DATA.teams.asu;
    const gf = filterGames(ga.games), af = filterGames(aa.games);
    const gaFor = sumField(gf, 'middle8_points_for');
    const gaAgainst = sumField(gf, 'middle8_points_against');
    const aaFor = sumField(af, 'middle8_points_for');
    const aaAgainst = sumField(af, 'middle8_points_against');

    let html = `<div class="section-enter">`;
    html += `<div class="glass rounded-xl p-4 mb-4"><div class="text-sm text-zinc-400"><strong class="text-white">Note:</strong> This data includes only 4th down conversion attempts ("going for it"), not punts or field goals.</div></div>`;
    html += `<div class="grid grid-cols-2 gap-4 mb-6">
        <div class="grid grid-cols-3 gap-3">
            ${statCard('Middle 8 PF', gaFor, '', 'team-a')}
            ${statCard('Middle 8 PA', gaAgainst, '', 'team-a')}
            ${statCard('Middle 8 Diff', gaFor-gaAgainst, '', 'team-a')}
        </div>
        <div class="grid grid-cols-3 gap-3">
            ${statCard('Middle 8 PF', aaFor, '', 'team-b')}
            ${statCard('Middle 8 PA', aaAgainst, '', 'team-b')}
            ${statCard('Middle 8 Diff', aaFor-aaAgainst, '', 'team-b')}
        </div>
    </div>`;
    html += compBar('Middle 8 Point Diff', gaFor-gaAgainst, aaFor-aaAgainst);
    html += `<div class="glass rounded-xl p-4 mt-4">${chartContainer('middle8Chart')}</div>`;

    const parseClock = (clock) => {
        if (!clock || typeof clock !== 'string') return -1;
        const parts = clock.split(':').map(Number);
        if (parts.length !== 2 || parts.some(n => Number.isNaN(n))) return -1;
        return parts[0] * 60 + parts[1];
    };
    const sortPlays = (plays) => plays.slice().sort((a, b) => {
        if ((a.game || 0) !== (b.game || 0)) return (a.game || 0) - (b.game || 0);
        if ((a.quarter || 0) !== (b.quarter || 0)) return (a.quarter || 0) - (b.quarter || 0);
        return parseClock(b.clock) - parseClock(a.clock);
    });

    const gaPlays = sortPlays(gf.flatMap(g => (g.middle8_scoring_plays||[]).filter(p => p.team === ga.abbr).map(p => ({...p, opponent: g.opponent, game: g.game_number}))));
    const aaPlays = sortPlays(af.flatMap(g => (g.middle8_scoring_plays||[]).filter(p => p.team === aa.abbr).map(p => ({...p, opponent: g.opponent, game: g.game_number}))));

    const renderPlays = (plays, teamClass, teamAbbr) => {
        if (!plays.length) return `<div class="text-zinc-500 text-xs p-4">No middle 8 scoring plays found.</div>`;
        return `<table class="w-full text-xs"><thead class="sticky top-0 bg-zinc-900"><tr>
            <th class="py-2 px-2 text-left text-zinc-500">G#</th>
            <th class="py-2 px-2 text-left text-zinc-500">Opponent</th>
            <th class="py-2 px-2 text-left text-zinc-500">Quarter</th>
            <th class="py-2 px-2 text-left text-zinc-500">Clock</th>
            <th class="py-2 px-2 text-left text-zinc-500">Team</th>
            <th class="py-2 px-2 text-right text-zinc-500">Points</th>
            <th class="py-2 px-2 text-right text-zinc-500">Points Against</th>
            <th class="py-2 px-2 text-left text-zinc-500">Description</th>
        </tr></thead><tbody>${plays.map(p => `<tr class="border-b border-white/5 table-row">
            <td class="py-1 px-2 text-zinc-400">G${p.game}</td>
            <td class="py-1 px-2">${p.opponent||''}</td>
            <td class="py-1 px-2">${p.quarter}</td>
            <td class="py-1 px-2 text-zinc-400">${p.clock||''}</td>
            <td class="py-1 px-2 ${teamClass}">${p.team||''}</td>
            <td class="py-1 px-2 text-right font-bold">${p.points}</td>
            <td class="py-1 px-2 text-right text-zinc-400">${p.team && p.team !== teamAbbr ? p.points : 0}</td>
            <td class="py-1 px-2 text-zinc-400">${(p.description||'').substring(0,90)}</td>
        </tr>`).join('')}</tbody></table>`;
    };

    html += `<div class="grid grid-cols-2 gap-4 mt-4">
        ${collapsible('Georgia Middle 8 Scoring Plays', gaPlays.length, renderPlays(gaPlays, 'team-a', ga.abbr))}
        ${collapsible('Arizona State Middle 8 Scoring Plays', aaPlays.length, renderPlays(aaPlays, 'team-b', aa.abbr))}
    </div>`;

    html += `</div>`;
    return html;
}

function initMiddle8Charts() {
    const gf = filterGames(DATA.teams.georgia.games), af = filterGames(DATA.teams.asu.games);
    const c = echarts.init(document.getElementById('middle8Chart'), 'dark');
    c.setOption({
        backgroundColor: 'transparent',
        tooltip: { 
            trigger: 'axis',
            formatter: (params) => {
                const i = params[0].dataIndex;
                const gGame = gf[i];
                const aGame = af[i];
                let tip = '';
                params.forEach(p => {
                    const g = p.seriesName === 'Georgia' ? gGame : aGame;
                    tip += `${p.marker} ${p.seriesName}: ${p.value}<br/>`;
                    if (g) tip += `vs ${g.opponent} ${g.date ? '(' + g.date + ')' : ''}<br/>`;
                });
                return tip;
            }
        },
        legend: { data: ['Georgia', 'Arizona State'], textStyle: { color: '#a1a1aa' } },
        xAxis: { type: 'category', data: gf.map((g,i) => 'G'+(i+1)), axisLabel: { color: '#71717a' } },
        yAxis: { type: 'value', axisLabel: { color: '#71717a' }, splitLine: { lineStyle: { color: 'rgba(255,255,255,0.05)' } } },
        series: [
            { name: 'Georgia', type: 'bar', data: gf.map(g => (g.middle8_points_for||0) - (g.middle8_points_against||0)), itemStyle: { color: '#ef4444' } },
            { name: 'Arizona State', type: 'bar', data: af.map(g => (g.middle8_points_for||0) - (g.middle8_points_against||0)), itemStyle: { color: '#f97316' } }
        ]
    });
    window.addEventListener('resize', () => c.resize());
}

function renderFourthDown() {
    const gf = filterGames(DATA.teams.georgia.games), af = filterGames(DATA.teams.asu.games);
    const gaAtt = sumField(gf, '4th_down_attempts');
    const gaConv = sumField(gf, '4th_down_conversions');
    const aaAtt = sumField(af, '4th_down_attempts');
    const aaConv = sumField(af, '4th_down_conversions');
    const gaPct = gaAtt ? (gaConv/gaAtt*100).toFixed(1) : '0.0';
    const aaPct = aaAtt ? (aaConv/aaAtt*100).toFixed(1) : '0.0';

    let html = `<div class="section-enter">`;
    html += `<div class="glass rounded-xl p-4 mb-4"><div class="text-sm text-zinc-400"><strong class="text-white">Note:</strong> This data includes only 4th down conversion attempts ("going for it"), not punts or field goals.</div></div>`;
    html += `<div class="grid grid-cols-2 gap-4 mb-6">
        <div class="grid grid-cols-3 gap-3">
            ${statCard('4th Att', gaAtt, '', 'team-a')}
            ${statCard('4th Conv', gaConv, gaPct+'%', 'team-a')}
            ${statCard('Conv %', gaPct, '', 'team-a')}
        </div>
        <div class="grid grid-cols-3 gap-3">
            ${statCard('4th Att', aaAtt, '', 'team-b')}
            ${statCard('4th Conv', aaConv, aaPct+'%', 'team-b')}
            ${statCard('Conv %', aaPct, '', 'team-b')}
        </div>
    </div>`;
    html += compBar('4th Down Conversion %', Number(gaPct), Number(aaPct), '%');
    html += `<div class="glass rounded-xl p-4 mt-4">${chartContainer('fourthChart')}</div>`;

    const renderGameTable = (games, teamClass) => {
        return `<div class="glass rounded-xl overflow-hidden mt-4">
            <div class="px-4 py-3 border-b border-white/5"><span class="font-semibold ${teamClass}">By Game</span> <span class="text-zinc-500 text-sm">4th Down</span></div>
            <table class="w-full text-xs"><thead class="bg-zinc-900"><tr>
                <th class="py-2 px-2 text-left text-zinc-500">Gm</th>
                <th class="py-2 px-2 text-left text-zinc-500">Opp</th>
                <th class="py-2 px-2 text-right text-zinc-500">Att</th>
                <th class="py-2 px-2 text-right text-zinc-500">Conv</th>
                <th class="py-2 px-2 text-right text-zinc-500">%</th>
            </tr></thead><tbody>${games.map(g => {
                const att = g['4th_down_attempts'] || 0;
                const conv = g['4th_down_conversions'] || 0;
                const pct = att ? (conv/att*100).toFixed(1) : '0.0';
                return `<tr class="border-b border-white/5 table-row">
                    <td class="py-1 px-2 text-zinc-400">G${g.game_number}</td>
                    <td class="py-1 px-2">${g.opponent}</td>
                    <td class="py-1 px-2 text-right">${att}</td>
                    <td class="py-1 px-2 text-right font-bold">${conv}</td>
                    <td class="py-1 px-2 text-right text-zinc-400">${pct}%</td>
                </tr>`;
            }).join('')}</tbody></table>
        </div>`;
    };

    html += `<div class="grid grid-cols-2 gap-4 mt-4">
        ${renderGameTable(gf, 'team-a')}
        ${renderGameTable(af, 'team-b')}
    </div>`;

    // 4th down play details
    const render4thDownTable = (games, teamAbbr, teamClass) => {
        const fourthPlays = games.flatMap((g,idx) => {
            return (g.play_tree||[]).flatMap(q => 
                q.drives.flatMap(d => 
                    d.plays.filter(p => p.offense === teamAbbr && (p.down_distance||'').startsWith('4-'))
                        .map(p => ({...p, game: g.game_number, opponent: g.opponent}))
                )
            );
        });
        if (!fourthPlays.length) return `<div class="text-zinc-500 text-xs p-4">No 4th down plays found.</div>`;
        return `<table class="w-full text-xs"><thead class="sticky top-0 bg-zinc-900"><tr>
            <th class="py-2 px-2 text-left text-zinc-500">G#</th>
            <th class="py-2 px-2 text-left text-zinc-500">Opponent</th>
            <th class="py-2 px-2 text-left text-zinc-500">Quarter</th>
            <th class="py-2 px-2 text-left text-zinc-500">Clock</th>
            <th class="py-2 px-2 text-left text-zinc-500">Down/Dist</th>
            <th class="py-2 px-2 text-left text-zinc-500">Spot</th>
            <th class="py-2 px-2 text-right text-zinc-500">Yards</th>
            <th class="py-2 px-2 text-left text-zinc-500">Description</th>
        </tr></thead><tbody>${fourthPlays.map(p => {
            const conv = (p.description||'').includes('1ST DOWN');
            return `<tr class="border-b border-white/5 table-row">
                <td class="py-1 px-2 text-zinc-400">G${p.game}</td>
                <td class="py-1 px-2">${p.opponent||''}</td>
                <td class="py-1 px-2">${p.quarter}</td>
                <td class="py-1 px-2 text-zinc-400">${p.clock||''}</td>
                <td class="py-1 px-2 text-zinc-400">${p.down_distance||''}</td>
                <td class="py-1 px-2 text-zinc-400">${p.spot||''}</td>
                <td class="py-1 px-2 text-right font-bold ${conv?'text-green-400':'text-red-400'}">${p.yards||0}</td>
                <td class="py-1 px-2 text-zinc-300">${(p.description||'').substring(0,100)}</td>
            </tr>`;
        }).join('')}</tbody></table>`;
    };

    const ga = DATA.teams.georgia, aa = DATA.teams.asu;
    html += `<div class="grid grid-cols-2 gap-4 mt-4">
        ${collapsible('Georgia 4th Down Plays', gf.flatMap(g => (g.play_tree||[]).flatMap(q => q.drives.flatMap(d => d.plays.filter(p => p.offense === ga.abbr && (p.down_distance||'').startsWith('4-'))))).length, render4thDownTable(gf, ga.abbr, 'team-a'))}
        ${collapsible('Arizona State 4th Down Plays', af.flatMap(g => (g.play_tree||[]).flatMap(q => q.drives.flatMap(d => d.plays.filter(p => p.offense === aa.abbr && (p.down_distance||'').startsWith('4-'))))).length, render4thDownTable(af, aa.abbr, 'team-b'))}
    </div>`;

    html += `</div>`;
    return html;
}

function initFourthDownCharts() {
    const gf = filterGames(DATA.teams.georgia.games), af = filterGames(DATA.teams.asu.games);
    const c = echarts.init(document.getElementById('fourthChart'), 'dark');
    c.setOption({
        backgroundColor: 'transparent',
        tooltip: { 
            trigger: 'axis',
            formatter: (params) => {
                const i = params[0].dataIndex;
                const gGame = gf[i];
                const aGame = af[i];
                let tip = '';
                params.forEach(p => {
                    const g = p.seriesName === 'Georgia' ? gGame : aGame;
                    tip += `${p.marker} ${p.seriesName}: ${p.value}%<br/>`;
                    if (g) tip += `vs ${g.opponent} ${g.date ? '(' + g.date + ')' : ''}<br/>`;
                });
                return tip;
            }
        },
        legend: { data: ['Georgia', 'Arizona State'], textStyle: { color: '#a1a1aa' } },
        xAxis: { type: 'category', data: gf.map((g,i) => 'G'+(i+1)), axisLabel: { color: '#71717a' } },
        yAxis: { type: 'value', axisLabel: { color: '#71717a', formatter: '{value}%' }, splitLine: { lineStyle: { color: 'rgba(255,255,255,0.05)' } } },
        series: [
            { name: 'Georgia', type: 'line', data: gf.map(g => {
                const att = g['4th_down_attempts'] || 0;
                const conv = g['4th_down_conversions'] || 0;
                return att ? +(conv/att*100).toFixed(1) : 0;
            }), itemStyle: { color: '#ef4444' }, smooth: true },
            { name: 'Arizona State', type: 'line', data: af.map(g => {
                const att = g['4th_down_attempts'] || 0;
                const conv = g['4th_down_conversions'] || 0;
                return att ? +(conv/att*100).toFixed(1) : 0;
            }), itemStyle: { color: '#f97316' }, smooth: true },
        ]
    });
    window.addEventListener('resize', () => c.resize());
}

function renderSpecialTeams() {
    const gf = filterGames(DATA.teams.georgia.games), af = filterGames(DATA.teams.asu.games);
    
    // Aggregate special teams data
    const gPunts = sumSpecial(gf, 'punts');
    const gPuntYds = sumSpecial(gf, 'punt_yards');
    const gPuntAvg = gPunts ? (gPuntYds / gPunts).toFixed(1) : '0.0';
    const gPuntInside20 = sumSpecial(gf, 'punts_inside_20');
    const gPuntLong = maxSpecial(gf, 'punt_return_long');
    
    const aPunts = sumSpecial(af, 'punts');
    const aPuntYds = sumSpecial(af, 'punt_yards');
    const aPuntAvg = aPunts ? (aPuntYds / aPunts).toFixed(1) : '0.0';
    const aPuntInside20 = sumSpecial(af, 'punts_inside_20');
    const aPuntLong = maxSpecial(af, 'punt_return_long');
    
    const gFgMade = sumSpecial(gf, 'field_goals_made');
    const gFgAtt = sumSpecial(gf, 'field_goals_attempts');
    const gFgPct = gFgAtt ? (gFgMade / gFgAtt * 100).toFixed(1) : '0.0';
    
    const aFgMade = sumSpecial(af, 'field_goals_made');
    const aFgAtt = sumSpecial(af, 'field_goals_attempts');
    const aFgPct = aFgAtt ? (aFgMade / aFgAtt * 100).toFixed(1) : '0.0';
    
    const gKoRetAvg = sumSpecial(gf, 'kickoff_return_avg') / gf.length;
    const gKoRetLong = maxSpecial(gf, 'kickoff_return_long');
    const aKoRetAvg = sumSpecial(af, 'kickoff_return_avg') / af.length;
    const aKoRetLong = maxSpecial(af, 'kickoff_return_long');
    
    const gPrRetAvg = sumSpecial(gf, 'punt_return_avg') / gf.length;
    const gPrRetLong = maxSpecial(gf, 'punt_return_long');
    const aPrRetAvg = sumSpecial(af, 'punt_return_avg') / af.length;
    const aPrRetLong = maxSpecial(af, 'punt_return_long');

    let html = `<div class="section-enter">`;
    
    // Punting section
    html += `<div class="glass rounded-xl p-4 mb-4"><div class="text-sm font-medium text-white mb-3">Punting</div>`;
    html += `<div class="grid grid-cols-2 gap-4">
        <div class="grid grid-cols-3 gap-3">
            ${statCard('Punt Avg', gPuntAvg, gPunts + ' punts', 'team-a')}
            ${statCard('Inside 20', gPuntInside20, '', 'team-a')}
            ${statCard('Longest', gPuntLong || 'â€”', '', 'team-a')}
        </div>
        <div class="grid grid-cols-3 gap-3">
            ${statCard('Punt Avg', aPuntAvg, aPunts + ' punts', 'team-b')}
            ${statCard('Inside 20', aPuntInside20, '', 'team-b')}
            ${statCard('Longest', aPuntLong || 'â€”', '', 'team-b')}
        </div>
    </div></div>`;
    
    // Field Goals section
    html += `<div class="glass rounded-xl p-4 mb-4"><div class="text-sm font-medium text-white mb-3">Field Goals</div>`;
    html += `<div class="grid grid-cols-2 gap-4">
        <div class="grid grid-cols-2 gap-3">
            ${statCard('FG %', gFgPct + '%', gFgMade + '/' + gFgAtt, 'team-a')}
            ${statCard('Longest', 'â€”', 'N/A', 'team-a')}
        </div>
        <div class="grid grid-cols-2 gap-3">
            ${statCard('FG %', aFgPct + '%', aFgMade + '/' + aFgAtt, 'team-b')}
            ${statCard('Longest', 'â€”', 'N/A', 'team-b')}
        </div>
    </div></div>`;
    
    // Returns section
    html += `<div class="glass rounded-xl p-4 mb-4"><div class="text-sm font-medium text-white mb-3">Returns</div>`;
    html += `<div class="grid grid-cols-2 gap-4">
        <div class="grid grid-cols-4 gap-3">
            ${statCard('KO Ret Avg', gKoRetAvg.toFixed(1), '', 'team-a')}
            ${statCard('KO Long', gKoRetLong, '', 'team-a')}
            ${statCard('PR Avg', gPrRetAvg.toFixed(1), '', 'team-a')}
            ${statCard('PR Long', gPrRetLong, '', 'team-a')}
        </div>
        <div class="grid grid-cols-4 gap-3">
            ${statCard('KO Ret Avg', aKoRetAvg.toFixed(1), '', 'team-b')}
            ${statCard('KO Long', aKoRetLong, '', 'team-b')}
            ${statCard('PR Avg', aPrRetAvg.toFixed(1), '', 'team-b')}
            ${statCard('PR Long', aPrRetLong, '', 'team-b')}
        </div>
    </div></div>`;
    
    html += compBar('Punt Avg', Number(gPuntAvg), Number(aPuntAvg));
    html += compBar('FG %', Number(gFgPct), Number(aFgPct), '%');
    html += `<div class="glass rounded-xl p-4 mt-4">${chartContainer('stChart')}</div>`;

    const renderStTable = (games, teamClass) => {
        return `<div class="glass rounded-xl overflow-hidden mt-4">
            <div class="px-4 py-3 border-b border-white/5"><span class="font-semibold ${teamClass}">By Game</span> <span class="text-zinc-500 text-sm">Special Teams</span></div>
            <table class="w-full text-xs"><thead class="bg-zinc-900"><tr>
                <th class="py-2 px-2 text-left text-zinc-500">Gm</th>
                <th class="py-2 px-2 text-left text-zinc-500">Opp</th>
                <th class="py-2 px-2 text-right text-zinc-500">FG</th>
                <th class="py-2 px-2 text-right text-zinc-500">Punts</th>
                <th class="py-2 px-2 text-right text-zinc-500">KO Ret</th>
                <th class="py-2 px-2 text-right text-zinc-500">PR</th>
            </tr></thead><tbody>${games.map(g => {
                const st = g.special_teams || {};
                const fg = `${st.field_goals_made||0}/${st.field_goals_attempts||0}`;
                return `<tr class="border-b border-white/5 table-row">
                    <td class="py-1 px-2 text-zinc-400">G${g.game_number}</td>
                    <td class="py-1 px-2">${g.opponent}</td>
                    <td class="py-1 px-2 text-right">${fg}</td>
                    <td class="py-1 px-2 text-right">${st.punts||0}</td>
                    <td class="py-1 px-2 text-right">${(st.kickoff_return_avg||0).toFixed(1)}</td>
                    <td class="py-1 px-2 text-right">${(st.punt_return_avg||0).toFixed(1)}</td>
                </tr>`;
            }).join('')}</tbody></table>
        </div>`;
    };

    html += `<div class="grid grid-cols-2 gap-4 mt-4">
        ${renderStTable(gf, 'team-a')}
        ${renderStTable(af, 'team-b')}
    </div>`;

    html += `</div>`;
    return html;
}

function initSpecialTeamsCharts() {
    const gf = filterGames(DATA.teams.georgia.games), af = filterGames(DATA.teams.asu.games);
    const c = echarts.init(document.getElementById('stChart'), 'dark');
    c.setOption({
        backgroundColor: 'transparent',
        tooltip: { 
            trigger: 'axis',
            formatter: (params) => {
                const i = params[0].dataIndex;
                const gGame = gf[i];
                const aGame = af[i];
                let tip = '';
                params.forEach(p => {
                    const g = p.seriesName === 'Georgia' ? gGame : aGame;
                    tip += `${p.marker} ${p.seriesName}: ${p.value}<br/>`;
                    if (g) tip += `vs ${g.opponent} ${g.date ? '(' + g.date + ')' : ''}<br/>`;
                });
                return tip;
            }
        },
        legend: { data: ['Georgia', 'Arizona State'], textStyle: { color: '#a1a1aa' } },
        xAxis: { type: 'category', data: gf.map((g,i) => 'G'+(i+1)), axisLabel: { color: '#71717a' } },
        yAxis: { type: 'value', axisLabel: { color: '#71717a' }, splitLine: { lineStyle: { color: 'rgba(255,255,255,0.05)' } } },
        series: [
            { name: 'Georgia', type: 'bar', data: gf.map(g => {
                const st = g.special_teams || {};
                return (st.kickoff_return_yards||0) + (st.punt_return_yards||0);
            }), itemStyle: { color: '#ef4444' } },
            { name: 'Arizona State', type: 'bar', data: af.map(g => {
                const st = g.special_teams || {};
                return (st.kickoff_return_yards||0) + (st.punt_return_yards||0);
            }), itemStyle: { color: '#f97316' } }
        ]
    });
    window.addEventListener('resize', () => c.resize());
}

function filterPlayTree(tree, query) {
    if (!query) return tree;
    const q = query.toLowerCase();
    return tree.map(qtr => {
        const drives = qtr.drives.map(d => {
            const plays = d.plays.filter(p => {
                const hay = [p.description, p.offense, p.down_distance, p.spot, p.clock].join(' ').toLowerCase();
                return hay.includes(q);
            });
            if (!plays.length) return null;
            return { drive_id: d.drive_id, offense: d.offense, plays };
        }).filter(Boolean);
        if (!drives.length) return null;
        return { quarter: qtr.quarter, drives };
    }).filter(Boolean);
}

function renderPlayTree(game, tree, primaryAbbr, primaryClass, secondaryClass) {
    const body = tree.map(q => {
        const drives = q.drives.map(d => {
            const plays = d.plays.map(p => `
                <div class="text-xs py-1 border-b border-white/5">
                    <span class="text-zinc-500 mr-2">Q${p.quarter||q.quarter}</span>
                    <span class="text-zinc-500 mr-2">${p.clock||''}</span>
                    <span class="text-zinc-400 mr-2">${p.down_distance||''}</span>
                    <span class="text-zinc-500 mr-2">${p.spot||''}</span>
                    <span class="${p.offense === primaryAbbr ? primaryClass : secondaryClass} mr-2 font-semibold">${p.offense||''}</span>
                    <span class="text-zinc-400 mr-1">${p.yards||0} yd${Math.abs(p.yards||0)!==1?'s':''}</span>
                    <span class="text-zinc-300">${p.description||''}</span>
                </div>`).join('');
            return `<details class="glass rounded-lg p-3 mt-2">
                <summary class="cursor-pointer text-xs text-zinc-400">Drive ${d.drive_id} Â· ${d.offense||''} Â· ${d.plays.length} plays</summary>
                <div class="mt-2">${plays}</div>
            </details>`;
        }).join('');
        return `<details class="glass rounded-xl p-3 mt-3">
            <summary class="cursor-pointer text-sm text-zinc-300">Quarter ${q.quarter}</summary>
            <div class="mt-2">${drives}</div>
        </details>`;
    }).join('');
    return `<div class="glass rounded-xl p-4">
        <div class="text-sm font-semibold ${primaryClass} mb-2">Game ${game.game_number} Â· vs ${game.opponent} ${game.date?'('+game.date+')':''}</div>
        ${body || '<div class="text-xs text-zinc-500">No plays match this filter.</div>'}
    </div>`;
}

function renderAllPlays() {
    const ga = DATA.teams.georgia, aa = DATA.teams.asu;
    const gf = filterGames(ga.games), af = filterGames(aa.games);
    let html = `<div class="section-enter">`;
    html += `<div class="glass rounded-xl p-4 mb-4"><div class="text-sm text-zinc-400"><strong class="text-white">Note:</strong> This data includes only 4th down conversion attempts ("going for it"), not punts or field goals.</div></div>`;
    html += `<div class="glass rounded-xl p-4 mb-4">
        <div class="text-xs text-zinc-500 mb-2">Search all plays</div>
        <input id="allPlaysSearch" class="w-full bg-zinc-900/60 border border-white/10 rounded-lg px-3 py-2 text-sm text-zinc-200 focus:outline-none focus:border-white/20" placeholder="Filter by team, down/distance, spot, or description..." value="${allPlaysQuery}" oninput="updateAllPlaysQuery(this.value)">
    </div>`;

    const renderTeamColumn = (games, primaryAbbr, primaryClass, secondaryClass) => {
        return games.map(g => {
            const tree = filterPlayTree(g.play_tree || [], allPlaysQuery.trim());
            return renderPlayTree(g, tree, primaryAbbr, primaryClass, secondaryClass);
        }).join('');
    };

    html += `<div class="grid grid-cols-2 gap-4">
        <div class="space-y-4">${renderTeamColumn(gf, ga.abbr, 'team-a', 'team-b')}</div>
        <div class="space-y-4">${renderTeamColumn(af, aa.abbr, 'team-b', 'team-a')}</div>
    </div>`;
    html += `</div>`;
    return html;
}

function updateAllPlaysQuery(val) {
    allPlaysQuery = val;
    renderTab();
}

// ===== RENDER ENGINE =====

const renderers = {
    overview: { render: renderOverview, init: initOverviewCharts },
    explosives: { render: renderExplosives, init: initExplosivesCharts },
    redzone: { render: renderRedzone },
    turnovers: { render: renderTurnovers, init: initTurnoverCharts },
    postturnovers: { render: renderPostTurnover, init: initPostTurnoverCharts },
    penalties: { render: renderPenalties, init: initPenaltyCharts },
    middle8: { render: renderMiddle8, init: initMiddle8Charts },
    '4thdown': { render: renderFourthDown, init: initFourthDownCharts },
    specialteams: { render: renderSpecialTeams, init: initSpecialTeamsCharts },
    allplays: { render: renderAllPlays },
};

function renderTab() {
    const main = document.getElementById('mainContent');
    const r = renderers[currentTab];
    main.innerHTML = r ? r.render() : '';
    if (r && r.init) setTimeout(r.init, 50);
}

function buildNav() {
    const nav = document.getElementById('tabNav');
    nav.innerHTML = TABS.map(t =>
        `<button class="nav-pill px-3 py-1.5 rounded-lg text-xs font-medium border border-transparent whitespace-nowrap ${t.id===currentTab?'active':''}" onclick="switchTab('${t.id}')">${t.icon} ${t.label}</button>`
    ).join('');
}

function buildFilters() {
    const bar = document.getElementById('filterBar');
    bar.innerHTML = '<span class="text-xs text-zinc-500 mr-1">Filter:</span>' + FILTERS.map(f =>
        `<button class="filter-chip px-2.5 py-1 rounded-md text-xs border border-white/10 ${f.id===currentFilter?'active':''}" onclick="switchFilter('${f.id}')">${f.label}</button>`
    ).join('');
}

function switchTab(id) {
    currentTab = id;
    buildNav();
    renderTab();
}

function updateHeader() {
    const ga = DATA.teams.georgia, aa = DATA.teams.asu;
    const gf = filterGames(ga.games), af = filterGames(aa.games);
    const gs = agg(gf), as_ = agg(af);
    document.getElementById('teamARecord').textContent = gs.record + ' Â· ' + ga.conference;
    document.getElementById('teamBRecord').textContent = as_.record + ' Â· ' + aa.conference;
}

function switchFilter(id) {
    currentFilter = id;
    buildFilters();
    updateHeader();
    renderTab();
}

// ===== INIT =====
fetch('data.json').then(r => r.json()).then(d => {
    DATA = d;
    const ga = d.teams.georgia, aa = d.teams.asu;
    document.getElementById('teamAName').textContent = ga.name;
    document.getElementById('teamBName').textContent = aa.name;
    buildNav();
    buildFilters();
    updateHeader();
    renderTab();
}).catch(e => {
    document.getElementById('mainContent').innerHTML = `<div class="glass rounded-xl p-8 text-center text-red-400">Failed to load data: ${e.message}</div>`;
});
</script>
<a href="https://vtsportssolutions.com" target="_blank" rel="noopener" style="position:fixed;bottom:1rem;right:1rem;z-index:40;display:flex;align-items:center;gap:0.5rem;padding:0.625rem 1rem;background:rgba(255,255,255,0.95);backdrop-filter:blur(8px);border-radius:9999px;box-shadow:0 4px 12px rgba(0,0,0,0.1);border:1px solid rgba(0,0,0,0.08);text-decoration:none;transition:transform 0.2s,box-shadow 0.2s;">
  <span style="font-size:0.75rem;color:#666;white-space:nowrap;">made with â¤ï¸ by</span>
  <img src="assets/vt-logo-text.png" alt="VT Sports Solutions" style="height:20px;">
</a>
</body>
</html>
